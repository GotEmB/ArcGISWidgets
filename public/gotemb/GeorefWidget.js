// Generated by CoffeeScript 1.5.0
var extend;

extend = function(obj, mixin) {
  var method, name;
  for (name in mixin) {
    method = mixin[name];
    obj[name] = method;
  }
  return obj;
};

define(["dojo/_base/declare", "dijit/_WidgetBase", "dijit/_TemplatedMixin", "dijit/_WidgetsInTemplateMixin", "dojo/text!./GeorefWidget/templates/GeorefWidget.html", "dojo/_base/connect", "esri/layers/ArcGISImageServiceLayer", "esri/request", "esri/layers/MosaicRule", "esri/geometry/Polygon", "dojox/form/FileInput", "dijit/form/Button"], function(declare, _WidgetBase, _TemplatedMixin, _WidgetsInTemplateMixin, template, _arg, ArcGISImageServiceLayer, request, MosaicRule, Polygon) {
  var connect;
  connect = _arg.connect;
  return declare([_WidgetBase, _TemplatedMixin, _WidgetsInTemplateMixin], {
    templateString: template,
    baseClass: "ClassifyWidget",
    map: null,
    imageFile: null,
    uploadForm: null,
    imageServiceUrl: "http://lamborghini.uae.esri.com:6080/arcgis/rest/services/gr_WorldImagery/ImageServer",
    imageServiceLayer: null,
    rastertype: null,
    imageIDs: [],
    postCreate: function() {
      var _this = this;
      this.imageServiceLayer = new ArcGISImageServiceLayer(this.imageServiceUrl);
      return connect(this.imageServiceLayer, "onLoad", function() {
        _this.imageServiceLayer.setOpacity(0);
        return _this.map.addLayer(_this.imageServiceLayer);
      });
    },
    upload: function() {
      var _this = this;
      if (this.imageFile.value.length === 0) {
        return console.error("An image must be selected!");
      }
      this.rastertype = this.imageFile.value.indexOf("las") === -1 ? "Raster Dataset" : "HillshadedLAS";
      console.info("Step 1/3: Uploading...");
      return request({
        url: this.imageServiceUrl + "/uploads/upload",
        form: this.uploadForm,
        content: {
          f: "json"
        },
        handleAs: "json",
        timeout: 600000,
        load: function(response1) {
          if (!response1.success) {
            return console.error("Unsuccessful upload:\n" + response1);
          }
          console.info("Step 2/3: Uploaded, processing the image on server side...");
          return request({
            url: _this.imageServiceUrl + "/add",
            content: {
              itemIds: response1.item.itemID,
              rasterType: _this.rastertype,
              minimumCellSizeFactor: 0.1,
              maximumCellSizeFactor: 10,
              f: "json"
            },
            handleAs: "json",
            load: function(response2) {
              var id;
              if (id = response2.addResults[0].rasterId) {
                console.info("Step 3/3: Navigate to the image.");
                _this.imageIDs.push(id.toString());
                if (_this.imageIDs.length > 0) {
                  _this.imageServiceLayer.setMosaicRule(extend(new MosaicRule, {
                    method: MosaicRule.METHOD_LOCKRASTER,
                    lockRasterIds: _this.imageIDs
                  }), true);
                }
                return request({
                  url: _this.imageServiceUrl + "/query",
                  content: {
                    objectIds: id,
                    returnGeometry: true,
                    outFields: "",
                    f: "json"
                  },
                  handleAs: "json",
                  load: function(response3) {
                    _this.map.setExtent(new Polygon(response3.features[0].geometry).getExtent().expand(2));
                    _this.imageServiceLayer.setOpacity(1);
                    return console.info("Succeeded!");
                  },
                  error: console.error
                });
              }
            },
            error: console.error
          }, {
            usePost: true
          });
        },
        error: console.error
      });
    }
  });
});
